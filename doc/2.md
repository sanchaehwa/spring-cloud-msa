## **Eureka Server**

### Eureka Server 기반의 Service Discovery 구조

1. **Eureka Server(Discovery Server) 구동**
    - Eureka Server는 마이크로서비스 환경에서 **Service Discovery의 중심** 역할을 수행
    - 모든 서비스 인스턴스는 Eureka Server에 **자기 자신을 등록**
2. **서비스 등록 (Service Registration)**
    - 각 마이크로서비스(MS)는 기동 시, Eureka Server에 자신의 정보(서비스 이름, IP 주소, 포트 등)를 **자동 등록**
3. **서비스 감지 (Service Discovery)**
    - 다른 마이크로서비스나 API Gateway는 Eureka Client 라이브러리를 통해, Eureka Server로부터 특정 서비스 인스턴스를 **검색**
    - 검색한 인스턴스는 **캐싱 (default 30초마다 refresh)**
4. **서비스 사용 (Routing & Load Balancing)**
    - 이 과정에서 **LoadBalancer**가 동작하여 인스턴스 간 **부하 분산**이 이루어짐
    - **API Gateway → Service Discovey→ 로드밸런서 → 인스턴스 선택 → 라우팅(각 서비스 인스턴스에서 실행)**
5. **서비스 상태 감시 (Heartbeat)**
    - 기본적으로 **heartbeat interval: 30초**
    - 기본적으로 **expiration timeout: 90초 (3번 실패)** → **90초 동안 heartbeat 못 받으면 DOWN 처리**
    - 30초에 3번 heartbeat가 아니라 → **30초마다 한번 보내고, 3번 실패시 DOWN 처리**
6. **동적 서비스 변경 감지**
    - 서비스 인스턴스가 추가되거나 종료되면, Eureka Server는 이를 **자동으로 감지**하고 목록을 갱신
    - 이를 통해 **서비스 중단 없이 유연한 확장/축소**가 가능.

### Eureka Server 기반의 Service Discovery 구조 (실습 적용)

0. Eureka Server(Discovery Server) , Service Instance 구현 및 실행
    - Eureka Server ⇒ `discoveryservice` 에 구현
    - Service Instance ⇒ `user-service` 에 구현
        - Terminal 에서 Service Instance 작동
            
             `mvn spring-boot:run`    (Maven 기반)
            

1. Eureka Server 구동 및  Service Instance 서비스 등록

```java
//설정파일에서 Eureka Server Port 번호 8761 설정(Sever 부팅)
INFO 56087 --- [discoveryservice] [           main] o.s.b.w.embedded.tomcat.TomcatWebServer  : Tomcat initialized with port 8761 (http)
//Service Instance 1 - Eureka Server에 등록
INFO 56087 --- [discoveryservice] [nio-8761-exec-2] c.n.e.registry.AbstractInstanceRegistry  : Registered instance USER-SERVICE/user-service:0:3b1e5052b832897bb70cc35b21983f49  with status UP (replication=false) //Client(User-Service Instance 1) Server 에 직접 등록 요청
INFO 56087 --- [discoveryservice] [nio-8761-exec-3] c.n.e.registry.AbstractInstanceRegistry  : Registered instance USER-SERVICE/user-service:0:3b1e5052b832897bb70cc35b21983f49  with status UP (replication=true) //Eureka Server 가 이 인스턴스를 등록했음을 알리는 부분
//Service Instance 2 - Eureka Server에 등록
 INFO 56087 --- [discoveryservice] [nio-8761-exec-5] c.n.e.registry.AbstractInstanceRegistry  : Registered instance USER-SERVICE/user-service:0:21aa5a040f5dfd30b8164e46c76717da  with status UP (replication=false)
 INFO 56087 --- [discoveryservice] [nio-8761-exec-7] c.n.e.registry.AbstractInstanceRegistry  : Registered instance USER-SERVICE/user-service:0:21aa5a040f5dfd30b8164e46c76717da  with status UP (replication=true)
```

Eureka Server에 두개의 Instance가 등록된것을 확인할 수 있음.
![EurekaServer등록](https://github.com/user-attachments/assets/7c4524f6-5538-442b-a382-92ccc9219f11)



2. 서비스를 동시에 실행을 시키려면 Port 번호를 각기 달리 설정해서 돌려야함 
    - Port 각 서비스 별로 등록 시켜주는 방법
        
        `mvn spring-boot:run -Dspring-boot.run.jvmArguments='-Dserver.port=9003'`
        
        → Dserver.port=9003 로 JVM argument를 주는 방식 → 실행할 때 포트 지정!
        
    - 각 서비스 별로 등록 시켜주면, 서비스가 많으면 복잡하고 번거로움
        - 랜덤 포트를 사용해서 서비스를 구동시킬때, 랜덤으로 포트번호를 발급받는 식으로해서,
            
            다른 포트에서 서비스를 실행시킬수 있도록 설정
            
            `${random.value}`  : **각 인스턴스마다 ID가 유니크하도록 보장**하는 설정
            
        
        ```java
        #0번으로 설정하는것은 랜덤 포트를 사용하겠다는 의미
        server.port=0
        spring.application.name=user-service
        #각 인스턴스가 Port로 구별되면서 개별 등록
        eureka.instance.instance-id=${spring.application.name}:${server.port}:${random.value} 
        eureka.instance.prefer-ip-address=true
        #Eureka Server 등록 여부
        eureka.client.register-with-eureka=true
        #Eureka Server 다른 인스턴스 정보를 가지고 올지에 대한 여부
        eureka.client.fetch-registry=true
        # User Service 가 Eureka Server에 등록할때 Eureka Sever의 주소 지정
        eureka.client.service-url.defaultZone=http://127.0.0.1:8761/eureka
        
        ```

        

### API Gateway 요청 처리 흐름 (Eureka 사용)

1. API. Gateway → Service Discovery 
    
    (1) 클라이언트의 요청이 API Gateway에 도착
    (2) API Gateway 내부에서 서비스 이름(user-service)으로 Service Discovery(Eureka)에 등록된 인스턴스 목록 조회
    
     예: user-service에 대한 Eureka 등록된 인스턴스 IP/포트 리스트 가져옴
    
2. API Gateway → Load Balancer
    1. Eureka 에 받아온 Instance 목록을  Load Balancer로 전달.
    2. 알고리즘 기반의 하나의 인스턴스 선택 
        
        ```java
        user-service 인스턴스 목록:
        - 192.168.0.101:9001
        - 192.168.0.102:9002
        ↓
        로드밸런서 선택: 192.168.0.101:9001
        ```
        
3. API Gateway 선택된 인스턴스에 요청 Proxy/Forwarding
